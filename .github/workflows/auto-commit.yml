name: Auto Commit with Weather & Motivation

on:
  schedule:
    - cron: '* * * * *'  # æ¯åˆ†é’Ÿè§¦å‘
  workflow_dispatch:

jobs:
  auto_commit:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®ä¸ºåŒ—äº¬æ—¶é—´
        run: |
          sudo ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

      - name: ç”Ÿæˆæˆ–è¯»å–ä»Šæ—¥æäº¤æ—¶é—´è®¡åˆ’
        id: plan
        run: |
          mkdir -p .github

          # âœ… æ¸…ç† 2 å¤©å‰çš„æ—§æ–‡ä»¶
          find .github -type f \( -name "auto_commit_plan_*.txt" -o -name "auto_commit_done_*.txt" \) -mtime +2 -delete

          TODAY=$(date +'%Y-%m-%d')
          PLAN_FILE=".github/auto_commit_plan_$TODAY.txt"

          if [[ -f "$PLAN_FILE" ]]; then
            echo "å·²å­˜åœ¨ä»Šæ—¥è®¡åˆ’ï¼š"
            cat "$PLAN_FILE"
          else
            COUNT=$((RANDOM % 4 + 2))  # 2~5 æ¬¡æäº¤
            TIMES=()
            while [ ${#TIMES[@]} -lt $COUNT ]; do
              HOUR=$((RANDOM % 15 + 8))  # 8~22 ç‚¹
              MIN=$((RANDOM % 60))
              TIME=$(printf "%02d:%02d" $HOUR $MIN)
              if [[ ! " ${TIMES[*]} " =~ " $TIME " ]]; then
                TIMES+=("$TIME")
                echo "$TIME" >> "$PLAN_FILE"
              fi
            done
            echo "ä»Šæ—¥æäº¤è®¡åˆ’ï¼š${TIMES[*]}"
          fi

      - name: æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦åŒ¹é…
        id: check
        run: |
          # âœ… åŠ é”é˜²å¹¶å‘
          LOCK_FILE="/tmp/auto_commit.lock"
          exec 200>"$LOCK_FILE"
          flock -n 200 || exit 0

          TODAY=$(date +'%Y-%m-%d')
          NOW=$(date +'%H:%M')
          PLAN_FILE=".github/auto_commit_plan_$TODAY.txt"
          DONE_FILE=".github/auto_commit_done_$TODAY.txt"

          mkdir -p .github
          touch "$DONE_FILE"

          SHOULD_RUN=false

          if grep -Fxq "$NOW" "$PLAN_FILE" && ! grep -Fxq "$NOW" "$DONE_FILE"; then
            echo "$NOW" >> "$DONE_FILE"
            echo "åŒ¹é…åˆ°è®¡åˆ’æ—¶é—´ $NOWï¼Œå‡†å¤‡æ‰§è¡Œæäº¤"
            SHOULD_RUN=true
          else
            echo "å½“å‰æ—¶é—´ $NOW ä¸åœ¨è®¡åˆ’å†…æˆ–å·²æ‰§è¡Œè¿‡"
          fi

          echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT

      - name: é€€å‡ºéæäº¤æ—¶é—´
        if: steps.check.outputs.should_run != 'true'
        run: echo "ä¸æ˜¯æäº¤æ—¶é—´ï¼Œé€€å‡ºä»»åŠ¡"

      - name: è·å–é‡åº†å®æ—¶å¤©æ°”ï¼ˆOpen-Meteoï¼‰
        id: weather
        run: |
          LAT=29.56301
          LON=106.55156
          DATA=$(curl -s "https://api.open-meteo.com/v1/forecast?latitude=$LAT&longitude=$LON&current=temperature_2m,weathercode&timezone=auto")
          TEMP=$(echo "$DATA" | jq '.current.temperature_2m')
          CODE=$(echo "$DATA" | jq '.current.weathercode')

          case $CODE in
            0) DESC="â˜€ï¸ æ™´å¤©" ;;
            1|2|3) DESC="â›… å¤šäº‘" ;;
            45|48) DESC="ğŸŒ«ï¸ é›¾éœ¾" ;;
            51|53|55|61|63|65) DESC="ğŸŒ¦ï¸ å°é›¨" ;;
            80|81|82) DESC="ğŸŒ§ï¸ é˜µé›¨" ;;
            95|96|99) DESC="â›ˆï¸ é›·æš´" ;;
            *) DESC="ğŸŒˆ æœªçŸ¥å¤©æ°”" ;;
          esac

          echo "weather_desc=$DESC" >> $GITHUB_OUTPUT
          echo "weather_temp=$TEMPÂ°C" >> $GITHUB_OUTPUT

      - name: é…ç½® Git
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      - name: å†™å…¥æ—¥å¿—å¹¶æäº¤
        run: |
          TODAY=$(date '+%Y-%m-%dï¼ˆ%Aï¼‰')
          TIME=$(date '+%H:%M:%S')
          LUNAR="å†œå†ï¼š$(date +'%m')æœˆ$(date +'%d')æ—¥"

          MSGS=(
            "ğŸŒŸ Keep going, everything you need will come to you."
            "ğŸ’ª Believe in yourself!"
            "ğŸš€ Push your limits!"
            "ğŸ”¥ Focus and win."
            "ğŸ€ Good things take time."
            "ğŸ± Stay curious."
            "ğŸ§  Learn something new today."
            "âœ¨ You are unstoppable."
          )
          MSG="${MSGS[$RANDOM % ${#MSGS[@]}]}"

          echo "ğŸ“… $TODAY" >> log.txt
          echo "â° $TIME" >> log.txt
          echo "ğŸ—“ï¸ $LUNAR" >> log.txt
          echo "â›… å¤©æ°”ï¼š${{ steps.weather.outputs.weather_desc }}ï¼Œ${{ steps.weather.outputs.weather_temp }}" >> log.txt
          echo "$MSG" >> log.txt

          COUNT_FILE=".github/commit_count.txt"
          if [ -f "$COUNT_FILE" ]; then
            COUNT=$(cat $COUNT_FILE)
          else
            COUNT=0
          fi
          COUNT=$((COUNT + 1))
          echo "$COUNT" > $COUNT_FILE
          echo "ğŸ”¢ å·²æäº¤ $COUNT æ¬¡" >> log.txt
          echo "----------------------------------------" >> log.txt

          git add log.txt $COUNT_FILE
          git commit -m "ğŸ“… Auto commit on $(date '+%Y-%m-%d')" || echo "æ— å˜åŒ–å¯æäº¤"

      - name: æ¨é€ä»£ç 
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git remote set-url origin https://x-access-token:$TOKEN@github.com/${{ github.repository }}.git
          git push origin HEAD:${{ github.ref_name }}
